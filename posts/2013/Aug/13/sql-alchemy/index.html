<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8">
        <title>SQL Alchemy</title>
        <link rel="stylesheet" href="../../../../../theme/css/main.css">
                <link href="http://www.pycourse.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Noisebridge Learning Python Atom Feed" />
                
        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../../">Noisebridge Learning Python </a></h1>
                <nav><ul>
                                                    <li><a href="../../../../../advanced-class-schedule/">Advanced Class Schedule</a></li>
                                    <li><a href="../../../../../schedule/">Class Schedule</a></li>
                                    <li><a href="../../../../../syllabus/">Welcome to Noisebridge Learning Python Class</a></li>
                                                                    <li class="active"><a href="../../../../../category/advanced.html">advanced</a></li>
                                                </ul></nav>
        </header><!-- /#banner -->
        <section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../../posts/2013/Aug/13/sql-alchemy/" rel="bookmark"
           title="Permalink to SQL Alchemy">SQL Alchemy</a></h1>
          </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2013-08-13T14:00:00">
                Tue 13 August 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../../../../../author/joseph-watters.html">Joseph Watters</a>
        </address>
        <p>In <a href="../../../../../category/advanced.html">advanced</a>. </p>

</footer><!-- /.post-info -->      <div class="section" id="intro">
<h2>Intro</h2>
<p><strong>Pros:</strong></p>
<ul class="simple">
<li>ORM, database logic can be written out in Python.</li>
<li>Impermeable to SQL insertion attacks.</li>
<li>Supports many database backends.</li>
</ul>
<p><strong>Cons:</strong></p>
<ul class="simple">
<li>Some API issues</li>
<li>Don’t use in production</li>
<li>Meant to remain small</li>
</ul>
</div>
<div class="section" id="set-up-your-db">
<h2>SET UP YOUR DB</h2>
<p>The create_engine instance: underlying constructs are Dialect and Pool.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&#39;sqlite:///:memory:&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="create-a-table">
<h2>Create a Table</h2>
<div class="highlight"><pre><span class="n">users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;user_name&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">40</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">40</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;password&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">)))</span>

<span class="n">users</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="run">
<h2>Run</h2>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">row</span>
</pre></div>
<p>We will need this method later to print our queries.</p>
</div>
<div class="section" id="populate">
<h2>Populate</h2>
<p>Your database will need some mock data, so point here for randomly generated data tables.</p>
<p><strong>Quick Populate:</strong></p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">add_user</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;users.csv&#39;</span><span class="p">,</span> <span class="s">&#39;rU&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">append_user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span>
            <span class="n">append_user</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">email</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">password</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">user_id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<div class="section" id="building-a-relationship">
<h2>Building a Relationship</h2>
<p>The creation of a related table is similar to our previous table, but with one addition. The <cite>ForeignKey('&lt;table.column&gt;')</cite> method will link rows of a secondary table with a primary table by storing a mapped value within the secondary table row. Importantly, a foreignkey must be identified when appending new rows with the intention of mapping foreignkey values with other tables.</p>
<p>In the following example, the user_id in the location table is mapped with the user_id column in the users table. The naming of a foreign key column does not require an exact copy of the mapped column name.</p>
<div class="highlight"><pre><span class="n">locations</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s">&#39;locations&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
                  <span class="n">Column</span><span class="p">(</span><span class="s">&#39;location_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="bp">True</span><span class="p">),</span>
                  <span class="n">Column</span><span class="p">(</span><span class="s">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;users.user_id&#39;</span><span class="p">)),</span>
                  <span class="n">Column</span><span class="p">(</span><span class="s">&#39;city&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
                  <span class="n">Column</span><span class="p">(</span><span class="s">&#39;state&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
                  <span class="n">Column</span><span class="p">(</span><span class="s">&#39;postal_code&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)))</span>
<span class="n">locations</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="joins">
<h2>Joins</h2>
<p>Join statements combine rows from two or more tables around a common field: the dictating of commonality allows for narrowed queries. Rows without common values can still be joined with other tables, but values may result in null values wherever conditions are not met in outer joins and ignored in inner joins.</p>
<p>The most common join is an inner join. It returns only the rows of tables where join parameters are met. SQLAlchemy allows for at least two methods to define tables and conditions where rows are to be joined.</p>
<div class="highlight"><pre><span class="n">select</span><span class="p">([</span><span class="o">&lt;</span><span class="n">table1</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">table2</span><span class="o">&gt;</span><span class="p">],</span><span class="o">&lt;</span><span class="n">conditions</span><span class="o">&gt;</span><span class="p">)</span>

<span class="n">select</span><span class="p">(</span><span class="n">users</span><span class="p">,</span><span class="n">locations</span><span class="p">)</span>
</pre></div>
<p>will print out the multiplicative value of the table. Adding a condition will produce a linear result. Adding further condition logic will tighten down results.</p>
<p><strong>Smart Join</strong></p>
<div class="highlight"><pre><span class="n">join</span><span class="p">(</span><span class="o">&lt;</span><span class="n">table1</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">table2</span><span class="o">&gt;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
<p>The opposite is an outer join, which returns a more inclusive query. An outer join in SQLAlchemy defaults to a left outer join. Ie. All rows from table1 will be returned and any corresponding rows from table2.
“Outer Join”</p>
<div class="highlight"><pre><span class="n">outerjoin</span><span class="p">(</span><span class="o">&lt;</span><span class="n">table1</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">table2</span><span class="o">&gt;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span>
</pre></div>
<p>With these two methods all it takes is a basic understanding of how joins behave in order to accurately dictate query results from multiple tables.</p>
</div>
<div class="section" id="fetching-and-selecting">
<h2>Fetching and Selecting:</h2>
<p>The select method produces a nontype sql query. Printing the contents of the query requires the <cite>execute()</cite> and <cite>fetch()</cite> methods.</p>
<p><strong>Fetch</strong></p>
<div class="highlight"><pre>Fetchone()
# To return
# Returns a single row
Fetchall()
#Returns a list of rows
</pre></div>
<p>Select statements are going to be the workhorse when it comes to querying. Here are the permutations of logic within a select method.</p>
<div class="highlight"><pre>select(and_()) | select()
# Conditional logic, all parameters must be met.

select(or())
#Conditional logic, one of the parameters must be met.

select(not_())
# Conditional logic, none of the parameters must be met.

select(&lt;&gt;.startswith(‘’))
# Value of column must start with string value in order to return row.

select(&lt;&gt;.like(‘’))
#Value of column must be like string value in order to return row.

select(&lt;&gt;.endswtih(‘’))
# Value of column must end with string value in order to return row.

select(&lt;&gt;.between(x,y))
#Value of column must be between values in order to return row.

select(&lt;&gt;.in_(&lt;array&gt;))
#Value of column must be in array in order to return row.

select([&lt;table or column&gt;], &lt;condition&gt;)
#Primary select utilization, tables or columns join around met conditions.
select([func.count(&lt;table.c.column&gt;)])
</pre></div>
</div>
<div class="section" id="indexing">
<h2>Indexing</h2>
<div class="highlight"><pre>Index(‘users_index’, users.c.user_name)
User = Table(‘users’, metadata,
    Column(‘name’, String(50), index=True)
</pre></div>
</div>
<div class="section" id="schema-migration">
<h2>Schema Migration</h2>
<p>Use either SQLAlchemy Migrate or Alembic for your migration needs. Although Alter statements and the DDL construct permit schema modifications, it is wise to utilize automated tools for easy migration. Documentation can be found at the links provided.</p>
</div>
<div class="section" id="mapper">
<h2>Mapper</h2>
<p>The <cite>mapper()</cite> function takes two parameters; the class and the object to be mapped.</p>
<div class="highlight"><pre><span class="n">Session</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">create_session</span><span class="p">()</span>
</pre></div>
</div>

    </div><!-- /.entry-content -->
        <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "posts/2013/Aug/13/sql-alchemy/";
        var disqus_url = "../../../../../posts/2013/Aug/13/sql-alchemy/";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://pycourse.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>
    
  </article>
</section>
        <section id="extras" class="body">
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://www.pycourse.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="http://www.eleddy.com">Liz's Site</a></li>
                                                    <li><a href="http://twitter.com/eleddy">Liz's Twitter</a></li>
                                                    <li><a href="http://kellanjacobs.com">Kellan's Site</a></li>
                                                    <li><a href="http://twitter.com/kellanjacobs">Kellan's Twitter</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'pycourse';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>